<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MFA-OTP"><title>MFA-OTP | A book about IDaaS</title><link rel=icon href=/idaas-book/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/idaas-book/main.min.css media=screen><link rel=stylesheet href=/idaas-book/custom.css media=screen></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/idaas-book/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/idaas-book/images/logos/logo.png alt="A book about IDaaS" width=38 height=38>
A book about IDaaS</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex>Keycloak</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/getting-started/ class=gdoc-nav__entry>Keycloak 简介</a></span></li><li><span class=flex>Admin API</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/admin-api/user-end2end/ class=gdoc-nav__entry>用户增删改查</a></span></li></ul></li><li><span class=flex>Troubleshooting</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/https-required/ class=gdoc-nav__entry>Https Required</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/export-import-on-k8s/ class=gdoc-nav__entry>Kubernetes中导入导出</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/liquibase-mysql-group-replication/ class=gdoc-nav__entry>Liquibase MGR</a></span></li></ul></li><li><span class=flex>安全增强功能</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/security-features/mfa/ class="gdoc-nav__entry is-active">MFA-OTP</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/security-features/password-policies/ class=gdoc-nav__entry>密码策略</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/security-features/brute-force-detection/ class=gdoc-nav__entry>暴力检测</a></span></li></ul></li></ul></li><li><span class=flex>参考资料</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/references/windows-ad/ class=gdoc-nav__entry>安装AD域服务并启用LDAPS</a></span></li></ul></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/idaas-book/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/idaas-book class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/idaas-book/edit/main/content/keycloak/security-features/mfa/index.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>MFA-OTP</h1><p><strong>MFA</strong> 即 Multi-Factor Authentication，多重身份认证，多因子认证，多因素认证。当然也包含等保要求中常说的双因子认证 2FA。</p><p>常见的实现如 U 盾、短信、邮件、指纹识别、面部识别等，在账户+密码基础上，进行二次或多次认证，增强数据安全。</p><p>Keycloak 提供了基于 OTP（One-Time Password，一次性密码，动态口令）的开箱即用的解决方案。</p><h2 id=使用步骤>使用步骤</h2><p>直接上图看效果。</p><ol><li>各个 Realm 默认的浏览器认证流中，OTP 是<code>CONDITIONAL</code>，是一个条件可选项。
<a href=./browser-otp.png><img src=./browser-otp.png alt=browser></a></li><li>为用户配置启用 OTP 认证。
<a href=./required-otp.png><img src=./required-otp.png alt="User OTP"></a></li><li>用户登录，未注册设备，要求注册设备。
<a href=./register-otp.png><img src=./register-otp.png alt=Register></a></li><li>手机端下载支持的 OTP 软件，如 FreeOTP，Google Authenticator。扫描注册，注册成功后就能看到已经生成一次性口令。
<a href=./freeotp.png><img src=./freeotp.png alt="FreeeOTP APP"></a></li><li>登录时就会要求输入一次性验证码。
<a href=./login-otp.png><img src=./login-otp.png alt=Login></a></li><li>注册成功后，可以在管理控制台看到用户注册的设备，用户也可以在自己的账户页面看到注册的设备。如果手机丢了想重新注册，把已有的记录删掉就可以，删掉后下次登录会要求重新注册。<br>管理控制台:
<a href=./admin-otp.png><img src=./admin-otp.png alt="Admin OTP"></a>
自己的账户页面：<br><a href=./account-otp.png><img src=./account-otp.png alt="Account OTP"></a></li></ol><h2 id=扩展认证方式>扩展认证方式</h2><p>如果想自己实现认证方式，官方也提供了详细的 SPI 开发指导，我们根据指导用一天时间实现了一个短信验证码。待开源。</p><h2 id=名字解释>名字解释</h2><p><strong>OTP</strong> One-Time Password，一般翻译为一次性密码、动态口令、动态验证码。</p><p><strong>HOTP</strong> HMAC-based One-Time Password，使用计数方式基于 HMAC 算法加密。算法协议为 <a href=https://tools.ietf.org/html/rfc2104>RFC 2104</a>.</p><p><strong>TOTP</strong> Time-based One-Time Password，基于时间戳算法，是时间同步，基于客户端的动态口令和服务器的时间比对，一般每 N 秒产生一个新口令，要求客户端和服务器能够保持正确的时钟，客户端和服务端基于时间计算的动态口令才能一致。算法协议为 <a href=https://tools.ietf.org/html/rfc6238>RFC 6238</a>.</p><p>开源实现</p><ul><li><a href=https://github.com/freeotp>FreeOTP</a>。</li><li><a href=https://github.com/google/google-authenticator>Google Authenticator</a>。</li></ul></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2021 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/idaas-book/js/en.search.min.js></script></body></html>