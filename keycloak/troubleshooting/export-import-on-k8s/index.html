<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kubernetes中导入导出"><title>Kubernetes中导入导出 | A book about IDaaS</title><link rel=icon href=/idaas-book/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/idaas-book/main.min.css media=screen><link rel=stylesheet href=/idaas-book/custom.css media=screen></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/idaas-book/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/idaas-book/images/logos/logo.png alt="A book about IDaaS" width=38 height=38>
A book about IDaaS</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex>Keycloak</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/getting-started/ class=gdoc-nav__entry>Keycloak 简介</a></span></li><li><span class=flex>Admin API</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/admin-api/user-end2end/ class=gdoc-nav__entry>用户增删改查</a></span></li></ul></li><li><span class=flex>Troubleshooting</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/https-required/ class=gdoc-nav__entry>Https Required</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/export-import-on-k8s/ class="gdoc-nav__entry is-active">Kubernetes中导入导出</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/liquibase-mysql-group-replication/ class=gdoc-nav__entry>Liquibase MGR</a></span></li></ul></li><li><span class=flex>安全增强功能</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/security-features/mfa/ class=gdoc-nav__entry>MFA-OTP</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/security-features/password-policies/ class=gdoc-nav__entry>密码策略</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/security-features/brute-force-detection/ class=gdoc-nav__entry>暴力检测</a></span></li></ul></li></ul></li><li><span class=flex>参考资料</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/references/windows-ad/ class=gdoc-nav__entry>安装AD域服务并启用LDAPS</a></span></li></ul></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/idaas-book/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/idaas-book class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/idaas-book/edit/main/content/keycloak/troubleshooting/export-import-on-k8s.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>Kubernetes中导入导出</h1><h2 id=问题描述>问题描述</h2><p>我的 keycloak 集群是跑在 Kubernetes 上，初始化了一些配置想完整的导出来。</p><p>比如按照官方的指导文档，在 keycloak pod 内用下面的命令导出。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./standalone.sh -Dkeycloak.migration.action<span class=o>=</span><span class=nb>export</span> -Dkeycloak.migration.provider<span class=o>=</span>singleFile -Dkeycloak.migration.file<span class=o>=</span>keycloak-export.json
</code></pre></div><p>出现类似下面错误。</p><pre><code class=language-log data-lang=log>ERROR [org.jboss.as.controller.management-operation] (Controller Boot Thread) WFLYCTL0013: Operation (&quot;add&quot;) failed - address: ([
    (&quot;core-service&quot; =&gt; &quot;management&quot;),
    (&quot;management-interface&quot; =&gt; &quot;http-interface&quot;)
]) - failure description: {
    &quot;WFLYCTL0080: Failed services&quot; =&gt; {&quot;org.wildfly.management.http.extensible&quot; =&gt; &quot;java.net.BindException: Address already in use /127.0.0.1:9990&quot;},
    &quot;WFLYCTL0288: One or more services were unable to start due to one or more indirect dependencies not being available.&quot; =&gt; {
        &quot;Services that were unable to start:&quot; =&gt; [&quot;org.wildfly.management.http.extensible.shutdown&quot;],
        &quot;Services that may be the cause:&quot; =&gt; [&quot;jboss.remoting.remotingConnectorInfoService.http-remoting-connector&quot;]
    }
}
</code></pre><h2 id=问题原因>问题原因</h2><p>根据错误提示，端口被占用，原因是 keycloak 导出脚本也会启动 Wildfly 服务，默认的 http、https、management 等的端口已经被占用。</p><h2 id=解决方案>解决方案</h2><p>命令行增加环境变量<code>-Djboss.socket.binding.port-offset=100</code>，指定不同的服务端口进行导出。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n keycloak <span class=nb>exec</span> -it keycloak-0 -- /opt/jboss/keycloak/bin/standalone.sh -Djboss.socket.binding.port-offset<span class=o>=</span><span class=m>100</span> -Dkeycloak.migration.action<span class=o>=</span><span class=nb>export</span> -Dkeycloak.migration.provider<span class=o>=</span>dir -Dkeycloak.migration.dir<span class=o>=</span>/tmp
</code></pre></div><p>导出成功后，Ctrl-C 停止导出的进程，再通过 <code>kubectl cp</code> 将文件复制出来。</p><p>另外注意导出的文件我放在了 <code>/tmp</code> 里，因为 pod 里默认的用户没有写权限。</p><p>如果导出的配置比较复杂，比如包含授权策略，导入时还可能会出现以下错误。</p><pre><code class=language-log data-lang=log>FATAL [org.keycloak.services] (ServerService Thread Pool -- 63) java.lang.RuntimeException: Script upload is disabled
</code></pre><p>解决方案，在导入命令里再追加一个环境变量。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  -Dkeycloak.profile.feature.upload_scripts<span class=o>=</span>enabled
</code></pre></div><h2 id=注意事项>注意事项</h2><ol><li>管理控制台也能导入导出，不过导出的不全，比如密码密钥肯定时无法导出的。</li><li>导出的文件是普通的 json 文件，可以按照他现有的格式根据需要自己去写，不必每次改动都导出一次。</li><li>Realm 配置、用户、Client 都可以通过 kcadm.sh 分别导入，所以如果有一些特殊定制，可以考虑将配置分开后独立导入。</li></ol></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2021 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/idaas-book/js/en.search.min.js></script></body></html>