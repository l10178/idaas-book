<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Liquibase MGR"><title>Liquibase MGR | A book about IDaaS</title><link rel=icon href=/idaas-book/favicon/favicon-32x32.png type=image/x-icon><link rel=stylesheet href=/idaas-book/main.min.css media=screen><link rel=stylesheet href=/idaas-book/custom.css media=screen></head><body><div class=wrapper><input type=checkbox class=hidden id=menu-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon arrow-back"><use xlink:href="#arrow_back"/></svg></label><a class=gdoc-header__link href=https://l10178.github.io/idaas-book/><span class="gdoc-brand flex align-center"><img class=gdoc-brand__img src=/idaas-book/images/logos/logo.png alt="A book about IDaaS" width=38 height=38>
A book about IDaaS</span></a></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><div class=gdoc-search><svg class="icon search"><use xlink:href="#search"/></svg><input type=text id=gdoc-search-input class=gdoc-search__input placeholder=Search... aria-label=Search maxlength=64><div class="gdoc-search__spinner spinner hidden"></div><ul id=gdoc-search-results class=gdoc-search__list></ul></div><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><span class=flex>Keycloak</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/getting-started/ class=gdoc-nav__entry>Keycloak 简介</a></span></li><li><span class=flex>Admin API</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/admin-api/user-end2end/ class=gdoc-nav__entry>用户增删改查</a></span></li></ul></li><li><span class=flex>Troubleshooting</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/https-required/ class=gdoc-nav__entry>Https Required</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/export-import-on-k8s/ class=gdoc-nav__entry>Kubernetes中导入导出</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/troubleshooting/liquibase-mysql-group-replication/ class="gdoc-nav__entry is-active">Liquibase MGR</a></span></li></ul></li><li><span class=flex>安全增强功能</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/keycloak/security-features/mfa/ class=gdoc-nav__entry>MFA-OTP</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/security-features/password-policies/ class=gdoc-nav__entry>密码策略</a></span></li><li><span class=flex><a href=/idaas-book/keycloak/security-features/brute-force-detection/ class=gdoc-nav__entry>暴力检测</a></span></li></ul></li></ul></li><li><span class=flex>参考资料</span><ul class=gdoc-nav__list><li><span class=flex><a href=/idaas-book/references/windows-ad/ class=gdoc-nav__entry>安装AD域服务并启用LDAPS</a></span></li></ul></li></ul></section><section class=gdoc-nav--more><h2>More</h2><ul class=gdoc-nav__list><li><span class=flex><svg class="icon download"><use xlink:href="#download"/></svg><a href=https://github.com/l10178/idaas-book/releases class=gdoc-nav__entry>Releases</a></span></li><li><span class=flex><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/l10178/idaas-book class=gdoc-nav__entry>View Source</a></span></li></ul></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap justify-between" itemscope itemtype=https://schema.org/Breadcrumb><span></span><span><svg class="icon code"><use xlink:href="#code"/></svg><a href=https://github.com/l10178/idaas-book/edit/main/content/keycloak/troubleshooting/liquibase-mysql-group-replication.md>Edit this page</a></span></div><article class=gdoc-markdown><h1>Liquibase MGR</h1><h2 id=问题描述>问题描述</h2><p>Keycloak 对接的是一个 MGR(mysql group replication)的集群，安装时出错，数据初始化失败。</p><p>查看 keycloak 启动日志，错误信息大致如下。</p><pre><code class=language-log data-lang=log>INFO  [org.keycloak.connections.jpa.updater.liquibase.LiquibaseJpaUpdaterProvider] (ServerService Thread Pool -- 66) Initializing database schema. Using changelog META-INF/jpa-changelog-master.xml
ERROR [org.keycloak.connections.jpa.updater.liquibase.conn.DefaultLiquibaseConnectionProvider] (ServerService Thread Pool -- 66) Change Set META-INF/jpa-changelog-1.0.0.Final.xml::
1.0.0.Final-KEYCLOAK-5461::sthorger@redhat.com failed.  Error: Table 'APPLICATION_DEFAULT_ROLES' already exists [Failed SQL: CREATE TABLE keycloak.APPLICATION_DEFAULT_ROLES (APPLICATION_ID VARCHAR(36) NOT NULL, ROLE_ID VARCHAR(36) NOT NULL)]
FATAL [org.keycloak.services] (ServerService Thread Pool -- 66) java.lang.RuntimeException: Failed to update database
INFO  [org.jboss.as.server] (Thread-2) WFLYSRV0220: Server shutdown has been requested via an OS signal
</code></pre><p>查看 MySQL 日志，看到如下错误。</p><pre><code class=language-log data-lang=log>[ERROR] Plugin group_replication reported: 'Table DATABASECHANGELOG does not have any PRIMARY KEY. This is not compatible with Group Replication'
</code></pre><h2 id=问题原因>问题原因</h2><p>根据 MySQL 日志，很明确了是因为 DATABASECHANGELOG 没有主键。MySQL group replication 要求表必须有主键或者非 Null 的唯一索引。</p><p>keycloak 使用 Liquibase 初始化数据。Liquibase 自动创建的 DATABASECHANGELOG 表没有主键，主要是为了避免特定数据库 key 的长度限制。查看 <a href=https://docs.liquibase.com/concepts/basic/databasechangelog-table.html>Liquibase 官方说明</a>，“id”, “author”, “filename”可以作为唯一索引。</p><h2 id=解决方案>解决方案</h2><p>解决办法也很简单，在 keycloak 启动之前，提前创建好 DATABASECHANGELOG 表并增加主键（或唯一性索引）。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=o>`</span><span class=n>DATABASECHANGELOG</span><span class=o>`</span> <span class=p>(</span>
  <span class=o>`</span><span class=n>ID</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>AUTHOR</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>FILENAME</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>DATEEXECUTED</span><span class=o>`</span> <span class=n>datetime</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>ORDEREXECUTED</span><span class=o>`</span> <span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>EXECTYPE</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>MD5SUM</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>35</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>DESCRIPTION</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>COMMENTS</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>TAG</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>LIQUIBASE</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>CONTEXTS</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>LABELS</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=o>`</span><span class=n>DEPLOYMENT_ID</span><span class=o>`</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=k>DEFAULT</span> <span class=k>NULL</span><span class=p>,</span>
  <span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=p>(</span><span class=o>`</span><span class=n>ID</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>AUTHOR</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>FILENAME</span><span class=o>`</span><span class=p>)</span>
<span class=p>)</span> <span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span> <span class=k>DEFAULT</span> <span class=n>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span>
</code></pre></div></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><div class="container flex flex-wrap"><span class=gdoc-footer__item>Copyright © 2020-2021 <a href=https://www.nxest.com class=gdoc-footer__link>nxest.com</a>.</span></div></footer></div><script defer src=/idaas-book/js/en.search.min.js></script></body></html>